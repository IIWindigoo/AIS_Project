#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –°–ø–æ—Ä—Ç–ö–ª—É–±

HOST="http://localhost:8000"
RUNTIME="5m"  # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞

echo "üìä –°–∫—Ä–∏–ø—Ç –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –°–ø–æ—Ä—Ç–ö–ª—É–±"
echo "=============================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ $HOST..."
if ! curl -s "$HOST/docs" > /dev/null 2>&1; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ $HOST"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π: ./start.sh"
    exit 1
fi

echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
echo ""

# –§–∞–∑–∞ 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ GET –∑–∞–ø—Ä–æ—Å–æ–≤
echo "üìå –§–ê–ó–ê 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–æ–≤"
echo "–¶–µ–ª—å: CPU < 60%, Failures < 1%"
echo "----------------------------------------"
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –§–∞–∑—É 1? (y/n): " phase1

if [ "$phase1" = "y" ]; then
    echo "üî• –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å GET –∑–∞–ø—Ä–æ—Å–∞–º–∏ (10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/—Å–µ–∫)..."
    locust -f locust_test.py \
        --host=$HOST \
        --tags get_task \
        --users 10 \
        --spawn-rate 2 \
        --run-time $RUNTIME \
        --html reports/phase1_get_only.html \
        --headless

    echo "‚úÖ –§–∞–∑–∞ 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç—á–µ—Ç: reports/phase1_get_only.html"
    echo ""
fi

# –§–∞–∑–∞ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ PUT –∑–∞–ø—Ä–æ—Å–æ–≤
echo "üìå –§–ê–ó–ê 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GET + PUT –∑–∞–ø—Ä–æ—Å–æ–≤"
echo "–¶–µ–ª—å: CPU < 60%, Failures < 1%"
echo "----------------------------------------"
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –§–∞–∑—É 2? (y/n): " phase2

if [ "$phase2" = "y" ]; then
    echo "üî• –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å GET –∏ PUT –∑–∞–ø—Ä–æ—Å–∞–º–∏ (15 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, 3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/—Å–µ–∫)..."
    locust -f locust_test.py \
        --host=$HOST \
        --tags get_task put_task \
        --users 15 \
        --spawn-rate 3 \
        --run-time $RUNTIME \
        --html reports/phase2_get_put.html \
        --headless

    echo "‚úÖ –§–∞–∑–∞ 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç—á–µ—Ç: reports/phase2_get_put.html"
    echo ""
fi

# –§–∞–∑–∞ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ POST –∑–∞–ø—Ä–æ—Å–æ–≤
echo "üìå –§–ê–ó–ê 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GET + PUT + POST –∑–∞–ø—Ä–æ—Å–æ–≤"
echo "–¶–µ–ª—å: CPU < 60%, Failures < 1%"
echo "----------------------------------------"
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –§–∞–∑—É 3? (y/n): " phase3

if [ "$phase3" = "y" ]; then
    echo "üî• –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–æ –≤—Å–µ–º–∏ —Ç–∏–ø–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, 4 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/—Å–µ–∫)..."
    locust -f locust_test.py \
        --host=$HOST \
        --users 20 \
        --spawn-rate 4 \
        --run-time $RUNTIME \
        --html reports/phase3_full.html \
        --headless

    echo "‚úÖ –§–∞–∑–∞ 3 –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç—á–µ—Ç: reports/phase3_full.html"
    echo ""
fi

# –§–∞–∑–∞ 4: –ü–æ–∏—Å–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
echo "üìå –§–ê–ó–ê 4: –ü–æ–∏—Å–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏"
echo "–¶–µ–ª—å: CPU 90-100%, Failures < 1%"
echo "----------------------------------------"
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –§–∞–∑—É 4? (y/n): " phase4

if [ "$phase4" = "y" ]; then
    echo "üî• –ó–∞–ø—É—Å–∫ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∞ (50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Å–µ–∫)..."
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞–≥—Ä—É–∑–∫–æ–π —Å–∏—Å—Ç–µ–º—ã!"
    locust -f locust_test.py \
        --host=$HOST \
        --users 200 \
        --spawn-rate 10 \
        --run-time $RUNTIME \
        --html reports/phase4_stress.html \
        --headless

    echo "‚úÖ –§–∞–∑–∞ 4 –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç—á–µ—Ç: reports/phase4_stress.html"
    echo ""
fi

echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
echo "üìÅ –û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: reports/"
echo ""
echo "üìä –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤ –æ—Ç–∫—Ä–æ–π—Ç–µ HTML —Ñ–∞–π–ª—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
echo "   - reports/phase1_get_only.html"
echo "   - reports/phase2_get_put.html"
echo "   - reports/phase3_full.html"
echo "   - reports/phase4_stress.html"
